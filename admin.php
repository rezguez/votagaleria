<?php// MANEJO DE SESIONES$session_options = array();session_start($session_options);if( !isset($_SESSION['ok']) )  $_SESSION['ok'] = false;// Establecer tiempo de vida de la sesión en segundos$inactividad = 600;// Comprobar si $_SESSION["timeout"] está establecidaif(isset($_SESSION["timeout"])){        // Calcular el tiempo de vida de la sesión (TTL = Time To Live)    $sessionTTL = time() - $_SESSION["timeout"];    if($sessionTTL > $inactividad){        session_destroy();        header("Location: login.php");     }}// El siguiente key se crea cuando se inicia sesión$_SESSION["timeout"] = time();if ($_SESSION['ok']==false) header("Location: index.php");
// connect to database$conn = mysqli_connect('localhost', 'root', '', 'bootstrap_gallery');if (!$conn) {    die("Error connecting to database: " . mysqli_connect_error($conn));    exit();}// if user clicks like or dislike buttonif (isset($_POST['action'])) {    $banner_id = $_POST['banner_id'];    $action = $_POST['action'];            switch ($action) {        case 'like':            $sql1 = "SELECT COUNT(*) FROM rating_info                 WHERE user_id = '$user_id' AND rating_action='like'";            $rs = mysqli_query($conn, $sql1);            $result = mysqli_fetch_array($rs);            if ($result[0]>2) break;            $sql="INSERT INTO rating_info (user_id, banner_id, rating_action)             VALUES ('$user_id', $banner_id, 'like')             ON DUPLICATE KEY UPDATE rating_action='like'";            break;        case 'unlike':            $sql="DELETE FROM rating_info WHERE user_id='$user_id' AND banner_id=$banner_id";            break;        default:            break;    }        // execute query to effect changes in the database ...    mysqli_query($conn, $sql);    echo getRating($banner_id);    exit(0);}// Get total number of likes for a particular postfunction getLikes($id){    global $conn;    $sql = "SELECT COUNT(*) FROM rating_info      WHERE banner_id = $id AND rating_action='like'";    $rs = mysqli_query($conn, $sql);    $result = mysqli_fetch_array($rs);    return $result[0];}// Get total number of likes and dislikes for a particular postfunction getRating($id){    global $conn;    $rating = array();    $likes_query = "SELECT COUNT(*) FROM rating_info WHERE banner_id = $id AND rating_action='like'";    $likes_rs = mysqli_query($conn, $likes_query);        $likes = mysqli_fetch_array($likes_rs);        $rating = [        'likes' => $likes[0],            ];    return json_encode($rating);}// Check if user already likes post or notfunction userLiked($banner_id){    global $conn;    global $user_id;    $sql = "SELECT * FROM rating_info WHERE user_id='$user_id'      AND banner_id=$banner_id AND rating_action='like'";    $result = mysqli_query($conn, $sql);    if (mysqli_num_rows($result) > 0) {        return true;    }else{        return false;    }}?><!DOCTYPE html><html lang="es"><head>  <meta charset="UTF-8">  <title>Like and Dislike system</title>  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />  <!-- Font Quicksand -->  <link href="https://fonts.googleapis.com/css?family=Quicksand:300,400,500,600,700&display=swap" rel="stylesheet">   <link rel="stylesheet" href="css/bootstrap.min.css">  <link rel="stylesheet" href="css/berta.css">  <link rel="stylesheet" href="css/berta2.css">  <link rel="stylesheet" href="css/magnific-popup.css">  <!--  <link rel="stylesheet" href="css/main.css">            <!-- Mis scripts --></head><body><!-- *************- MAIN ************* --> <main style='background-color:#ffeeca'><!-- *************- nav ************* -->   <nav class="navbar navbar-expand-md m-0 p-0 navbar-dark caobut2">  <div class="col-12 col-md-2">  	<a class="navbar-brand bertateka ml-2" href="index.php">Bertateka</a>  </div>  <div class="col-auto mx-auto">	<h4>GALERÍA DE IMÁGENES <span class="badge badge-warning" style="font-size: 0.5em;" >(ADMIN)</span></h4></div> </nav> <!-- EMPIEZA container --> <div class='container-fluid'><!-- EMPIEZA mainbox --><div  class='mainbox  mx-auto mt-3'><!-- *******************  GRID DE LA PAGINA ************<!-- EMPIEZA FILA PRINCIPAL --><div class='row'><div class='col-10 col-lg-11 mx-auto'><!-- ************ GALERIA ************* --><div class="popup-gallery"><div class="card-deck mb-4">		<?php			$nums=1;			$sql_banner_top=mysqli_query($conn,"select * from banner where estado=1");			while($resultado=mysqli_fetch_array($sql_banner_top)){			    $post[$resultado['id']]=[ getLikes($resultado['id']), $resultado['url_image']];			}			rsort($post);			foreach ($post as $key=>$value){		?>  <div class="card">      <img src="images/<?php echo $value[1]; ?>" class="card-img-top test-popup-link">      <div class="card-footer"><?php echo ($value[0]>0 ? $value[0] : 0). " voto(s)"; ?>      </div>    </div><?php 			if ($nums%4==0){				echo '</div><div class="card-deck">';			}		$nums++;			}		?>	</div></div><!-- ************ END GALERIA  ************* --></div></div></div><!-- FIN PRINCIPAL -->    </div><!-- FIN mainbox --></div><!-- FIN container --></main><!-- FIN MAIN --><?php include_once 'inc/footer.inc'; ?></div></body></html>